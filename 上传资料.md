# SMS 學生成績上傳系統 - 完整自動化工作流程

## 目標
自動化 SMS 系統的學生成績提交流程，包括：
1. ✅ 自動登入 SMS
2. ✅ 填寫活動日期和代碼
3. ✅ 自動添加學生名單
4. ✅ 從頁面提取英文名並寫入 Excel
5. ✅ 自動填寫「奪勵分數類型」和「備註」
6. ✅ 自動提交表單

---

## 使用檔案

### 讀入檔案
- `Upload.xlsx` - 學生資料表（包含班級、學號、中文名、備註等）

### 主要程序
- `fill_english_names_v2.py` - 完整自動化腳本（~450 行）

---

## 網站信息

### 登入頁面
- **URL**: https://sms.chhsban.edu.my/sms/index.php?r=site/login
- **帳號**: schhs334
- **密碼**: schhs334

### 活動填寫頁面
- **URL**: https://sms.chhsban.edu.my/sms/index.php?r=transaction/studentPerformance/create

---

## Excel 檔案結構

### Upload.xlsx 格式

| 列 | 欄位 | 說明 |
|---|------|------|
| A1 | 日期 | 格式: `yyyy-MM-dd`（例：`2024-11-24`） |
| A2 | 活動代碼 | 例：`ACA CMO183` |
| **第 4 行** | **標題列** | A=班級, B=學號, C=姓名, D=備註, E=英文名(待填) |
| **第 5+ 行** | **學生資料** | 逐行填寫學生資訊 |

**示例**:
```
A1: 2024-11-24
A2: ACA CMO183
A4: 班級 | 學號 | 姓名 | 備註 | 英文名
A5: S3A | 20071 | 梁毓宏 | gold |
A6: S3A | 20091 | 邓竞康 | silver |
A7: S3B | 20044 | 刘恩哲 | bronze |
```

**重要說明**：
- **Column E（英文名）**: 腳本會自動從 SMS 系統提取，寫入此欄
- **Column D（備註）**: 必須預先填寫，腳本會在表單提交時填入系統
- **去重邏輯**: 如 Excel 含重複學號，腳本會自動跳過重複項

---

## 完整工作流程

### 步驟總覽

```
步驟 1    → 登入 SMS
步驟 2    → 進入活動創建頁面
步驟 3    → 填寫日期（A1）& 活動代碼（A2）
步驟 4    → 點擊學生名單按鈕
步驟 5    → 循環添加學生（每班級）
步驟 6    → 關閉 Modal，返回上一頁
步驟 9.5  → 選擇奪勵分數類型（校外學藝）
步驟 9.6  → 填寫備註（來自 Excel D 欄）
步驟 10   → 提交表單
```

### 詳細步驟說明

#### **步驟 1-3: 登入、填寫基本資訊**

```
1. [登入] → SMS 登入頁面
   ├─ 輸入帳號: schhs334
   ├─ 輸入密碼: schhs334
   └─ 等待 URL 變更（確認登入成功）
   
2. [進入活動頁面] → 活動創建頁面自動加載
   
3. [填寫日期和活動]
   ├─ 日期: 從 Excel A1 讀取 (yyyy-MM-dd 格式)
   ├─ 活動: 從 Excel A2 讀取 (Select2 下拉選擇)
   └─ 確認填寫完成
```

#### **步驟 4-6: 添加學生名單**

```
4. [點擊學生名單按鈕]
   ├─ 按鈕 ID: yw4
   └─ 打開 Modal (studentModal)
   
5. [循環添加學生（逐班級）]
   ├─ 遍歷 Excel，識別班級分組
   ├─ 對每個班級:
   │  ├─ 選擇班級 (class_id 下拉)
   │  ├─ 等待表格加載 (table.table tbody tr)
   │  ├─ 對該班級的每個學生:
   │  │  ├─ 查找學號（Excel B 欄 vs 表格第 1 列）
   │  │  ├─ 抓取英文名（表格第 2 列）
   │  │  ├─ 點擊「添加」按鈕
   │  │  ├─ 寫入 Excel E 欄
   │  │  └─ 記錄至 added_students_set
   │  │     （用於步驟 9.5/9.6 時識別新添加的學生）
   │  └─ 切換班級（重複此班級循環）
   
6. [關閉 Modal 返回上一頁]
   ├─ 點擊 #studentModal a.close
   └─ 頁面自動返回表單（顯示已添加的學生列表）
```

#### **步驟 9.5: 選擇奪勵分數類型**

```
9.5. [為每位學生選擇「校外學藝」]
   ├─ 遍歷頁面返回後的表格
   ├─ 僅處理 added_students_set 中的學生
   │  （跳過歷史數據，防止重複處理）
   ├─ 對每位學生:
   │  ├─ 提取 <tr class="4656"> 中的內部 ID
   │  ├─ 定位 select[name="...inputperformance...[type_of_bonus]"]
   │  ├─ 選擇 value="1"（校外學藝）
   │  └─ 列印確認訊息
```

#### **步驟 9.6: 填寫備註**

```
9.6. [為每位學生填寫備註]
   ├─ 再次遍歷頁面表格
   ├─ 僅處理 added_students_set 中的學生
   ├─ 對每位學生:
   │  ├─ 提取 <tr> 中的內部 ID
   │  ├─ 在 Excel 中查找該學號，讀取 D 欄備註
   │  ├─ 定位 textarea#StudentPerformanceM_inputperformance_{id}_remark
   │  ├─ 清空並填入備註文字
   │  └─ 列印確認訊息
```

#### **步驟 10: 提交表單**

```
10. [提交表單]
   ├─ 點擊 #yw7（創建按鈕）
   ├─ 等待表單提交完成
   └─ 關閉瀏覽器
   
腳本已自動執行無停頓，無需手動確認。
```

---

## HTML 元素參考

### 登入表單
```html
<input id="LoginForm_username" type="text" />
<input id="LoginForm_password" type="password" />
<button type="submit">登入</button>
```

### 活動填寫表單
```html
<!-- 日期輸入 -->
<input id="StudentPerformanceM_date" type="text" />

<!-- 活動代碼 (Select2 下拉) -->
<select id="StudentPerformanceM_item_id">
  <option value="2207">ACA CMO183 - Malaysian Physics Olympiad (OFM) 2025</option>
  <!-- 更多選項 -->
</select>

<!-- 學生名單按鈕 -->
<button id="yw4">學生名單</button>
```

### Modal - 班級選擇
```html
<select id="class_id" onchange="changeGridStudentList();">
  <option value="682">高三忠 (S3A)</option>
  <option value="683">高三孝 (S3B)</option>
  <!-- 更多班級選項 -->
</select>
```

### Modal - 學生表格
```html
<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>學號</th>
      <th>姓名(英)</th>
      <th>姓名(中)</th>
      <th>班級</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <!-- 重要: 內部 ID 在 <tr class="4656"> 中 -->
    <tr class="4656">
      <td>20071</td>
      <td>LEONG YORK HONG</td>
      <td>梁毓宏</td>
      <td>S3A</td>
      <td>
        <a onclick="addToEkstra(this);return false;" 
           data-student_id="4656" 
           class="btn">
          <icon class="icon-ok"></icon>
        </a>
      </td>
    </tr>
  </tbody>
</table>
```

### 返回後的學生列表 (用於步驟 9.5/9.6)
```html
<table class="table">
  <tbody>
    <tr class="4656">
      <!-- ... -->
      
      <!-- 步驟 9.5: 奪勵分數類型選擇 -->
      <td>
        <select name="StudentPerformanceM[inputperformance][4656][type_of_bonus]">
          <option value="1">校外學藝</option>
          <option value="2">特殊表現</option>
        </select>
      </td>
      
      <!-- 步驟 9.6: 備註欄位 -->
      <td>
        <textarea id="StudentPerformanceM_inputperformance_4656_remark" 
                  name="StudentPerformanceM[inputperformance][4656][remark]">
        </textarea>
      </td>
    </tr>
  </tbody>
</table>
```

### 提交按鈕
```html
<button id="yw7" type="submit" class="btn btn-primary">創建</button>
```

---

## Python 實現

### 核心依賴
```
selenium >= 4.0
webdriver-manager >= 3.8.0
openpyxl >= 3.0
```

### 快速開始

1. **安裝依賴**
```bash
pip install selenium webdriver-manager openpyxl
```

2. **準備 Excel 檔案**
   - 確保 `Upload.xlsx` 包含正確格式的數據

3. **執行腳本**
```bash
python fill_english_names_v2.py
```

腳本會自動執行以下操作：
- ✅ 登入 SMS
- ✅ 填寫日期和活動代碼
- ✅ 添加所有學生到名單
- ✅ 提取英文名寫入 Excel
- ✅ 選擇奪勵分數類型
- ✅ 填寫備註
- ✅ 提交表單

---

## 核心代碼片段

### 步驟 9.5: 選擇奪勵分數類型

```python
# 建立已添加學生的集合（用於篩選）
added_students_set = set(...)  # 在步驟 5 期間建立

# 遍歷頁面表格，只處理本次添加的學生
table_rows = driver.find_elements(By.CSS_SELECTOR, 'table.table tbody tr')

for row in table_rows:
    cols = row.find_elements(By.TAG_NAME, 'td')
    if not cols:
        continue
    
    student_no_from_page = cols[0].text.strip()
    
    # 只處理本次添加的學生（跳過歷史數據）
    if student_no_from_page not in added_students_set:
        continue
    
    # 從 <tr class="4656"> 提取內部 ID
    tr_class = row.get_attribute('class')
    internal_id = tr_class.strip() if tr_class else None
    
    if not internal_id:
        continue
    
    # 選擇「校外學藝」(value="1")
    try:
        select_elem = driver.find_element(
            By.CSS_SELECTOR,
            f'select[name="StudentPerformanceM[inputperformance][{internal_id}][type_of_bonus]"]'
        )
        select_obj = Select(select_elem)
        select_obj.select_by_value("1")
        print(f"[+] {student_no_from_page} 已選擇「校外學藝」")
    except Exception as e:
        print(f"[!] {student_no_from_page} 選擇失敗: {e}")
```

### 步驟 9.6: 填寫備註

```python
# 再次遍歷表格，填寫備註
for row in table_rows:
    cols = row.find_elements(By.TAG_NAME, 'td')
    if not cols:
        continue
    
    student_no_from_page = cols[0].text.strip()
    
    # 只處理本次添加的學生
    if student_no_from_page not in added_students_set:
        continue
    
    # 在 Excel 中查找學號，讀取 D 欄備註
    excel_remark = None
    for row_idx in range(5, ws.max_row + 1):
        excel_student_id = ws.cell(row=row_idx, column=2).value
        if str(excel_student_id).strip() == student_no_from_page:
            excel_remark = ws.cell(row=row_idx, column=4).value or ""
            break
    
    if excel_remark is None:
        continue
    
    # 從 <tr> 提取內部 ID
    tr_class = row.get_attribute('class')
    internal_id = tr_class.strip() if tr_class else None
    
    if not internal_id:
        continue
    
    # 填寫備註
    try:
        textarea_elem = driver.find_element(
            By.ID,
            f'StudentPerformanceM_inputperformance_{internal_id}_remark'
        )
        textarea_elem.clear()
        textarea_elem.send_keys(str(excel_remark))
        print(f"[+] {student_no_from_page} 已填寫備註: {excel_remark}")
    except Exception as e:
        print(f"[!] {student_no_from_page} 填寫備註失敗: {e}")
```

### 去重邏輯

```python
# Excel 讀取時自動去重
from collections import defaultdict

students_by_class = defaultdict(list)
seen_pairs = set()  # 用於去重: (class, student_id)

for row_idx in range(5, ws.max_row + 1):
    class_val = ws.cell(row=row_idx, column=1).value
    id_val = ws.cell(row=row_idx, column=2).value
    
    if not id_val:
        continue
    
    pair = (str(class_val).strip(), str(id_val).strip())
    
    # 跳過重複
    if pair in seen_pairs:
        print(f"  [去重] 跳過重複的 {pair[0]} - {pair[1]}")
        continue
    
    seen_pairs.add(pair)
    students_by_class[pair[0]].append((row_idx, pair[1]))

print(f"[✓] 共識別 {len(seen_pairs)} 個不重複的學生")
```

---

## 常見問題 & 解決方案

| 問題 | 原因 | 解決方案 |
|------|------|--------|
| 登入失敗 | 帳號/密碼錯誤 | 檢查憑證；在瀏覽器手動測試 |
| Select2 選擇失敗 | 活動代碼不存在或格式錯誤 | 檢查 Excel A2 是否正確填寫 |
| 找不到學生 | 表格尚未加載 | 增加 wait 時間至 10 秒 |
| 按鈕無法點擊 | DOM 元素已移除 | 重新定位元素（不可重複使用舊引用） |
| 編碼錯誤 (PowerShell) | 終端編碼為 cp950 | 腳本已包含 UTF-8 宣言 `# -*- coding: utf-8 -*-` |
| 找不到內部 ID | 頁面 HTML 結構改變 | 檢查 `<tr class="xxx">` 屬性是否存在 |

---

## 已驗證的環境

✅ **硬體/軟體**：
- Python 3.14
- Selenium 4.0+
- Chrome 瀏覽器 (最新版)
- openpyxl 3.0+
- Windows 10 PowerShell

✅ **已成功測試功能**：
- ✓ 登入 SMS 系統
- ✓ 填寫日期和活動代碼（Select2 插件）
- ✓ 開啟學生名單 Modal
- ✓ 班級選擇與表格加載
- ✓ 學生查找與英文名提取 (6/6)
- ✓ 批量添加學生 (100% 成功)
- ✓ 選擇「校外學藝」分數類型 (6/6)
- ✓ 填寫備註資訊 (6/6)
- ✓ 去重邏輯（防止重複處理）
- ✓ 表單提交

---

## 安全建議

### 凭证管理
不要在代碼中硬編碼密碼。改用環境變數：
```python
import os
USERNAME = os.getenv("SMS_USERNAME", "schhs334")
PASSWORD = os.getenv("SMS_PASSWORD", "schhs334")
```

### 依賴安全
定期更新套件：
```bash
pip install --upgrade selenium webdriver-manager openpyxl
```

---

## 下一步改進

- [ ] 支援多活動批量提交
- [ ] 錯誤重試機制
- [ ] 詳細日誌記錄
- [ ] 進度條顯示
- [ ] 郵件通知結果
- [ ] 環境變數支援凭证

---

## 版本歷史

| 版本 | 日期 | 改進 |
|------|------|------|
| 2.0 | 2025-11-14 | 完整工作流程 + 去重邏輯 + 篩選新添加學生 + 步驟 9.5/9.6 實現 |
| 1.0 | 2025-11-13 | 初始版本：基本登入和學生添加功能 |

---

## 聯繫與支援

- 如有問題，查看腳本輸出的詳細錯誤訊息
- 檢查 HTML 結構是否變更（特別是選擇器和內部 ID）
- 參考本文檔的「HTML 元素參考」章節驗證元素位置

**最後更新**: 2025-11-14


