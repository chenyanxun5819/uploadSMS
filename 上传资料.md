# 上传学生学术资料成绩至 SMS 系统

## 使用档案
- `Upload.xlsx`

## 写入档案
- `upload.py`
## 登入网站
- 链接: https://sms.chhsban.edu.my/sms/index.php?r=site/login

## 登入表单（XPath）
- username: `//*[@id="login-form"]/div[3]/label`
- password: `//*[@id="LoginForm_password"]`
- submit: `//*[@id="login-form"]/div[4]/div/button`

> 注意：此处未放真实凭证。请不要在仓库或公开档案中保存明文账号/密码。若要本地测试，请把真实凭证放在受保护的环境变量或本地配置文件中。

示例占位符（仅举例，不是真凭证）：
- username: `schhs334@chhsban.edu.my`
- password: `schhs334`

## 输入活动基本资料页面
- 页面: https://sms.chhsban.edu.my/sms/index.php?r=transaction/studentPerformance/create

字段对应（XPath 与 Excel 对应）
- 活动日期（Excel `A1`）  
  - XPath: `//*[@id="StudentPerformanceM_date"]`  
  - 日期格式: `yyyy-MM-dd`（例：`2025-11-24`）
- 活动项目（Excel `A2`）    
  - **推荐方法**：使用 JavaScript + jQuery Select2 API（见下方「编码实现」章节）
  - HTML 元素：`id="StudentPerformanceM_item_id"`（hidden select 元素）
  - Select2 容器：`id="s2id_StudentPerformanceM_item_id"`
  - 说明：`A2` 存放「活动代码」（例：`ACA CMO183`）。由于页面使用 **Select2 jQuery 插件**，不能直接通过 XPath 点击或输入。需要通过 JavaScript 操作：
    1. 调用 `$('#StudentPerformanceM_item_id').select2('open')` 打开下拉菜单
    2. 向搜索输入框 `.select2-input` 输入活动代码
    3. 触发搜索事件
    4. 点击搜索结果或直接设置 select 的 value
  - 完整实现见下方「通过 Select2 选择活动项目」代码块
- 学生名单按钮  
 - 学生名单按钮  
   - XPath: `//*[@id="yw4"]`

### 选择班级与查找学生（按 Excel studentId）

当点击 **学生名单按钮**（`id="yw4"`）后，页面会弹出班级选择下拉和学生名单表格。下拉是普通的 HTML `select`（`id="class_id"`），其中选项为全称，如 `初三孝 (S3B)`；但 Excel 中通常只填写简写（例如 `S3B`）。

流程摘要：
- **读取 Excel**：从 `Upload.xlsx` 中读取学生清单（Student 列含 `class` 与 `studentId`）。
- **选择班级**：在页面上找到 `select#class_id`，遍历 `<option>`，匹配括号内的短代码（例如 `(S3B)`），然后用 `Select` 或点击选中该 option。
- **等待表格载入**：选择班级后，等待表格（`<table class="table ...">`）更新并显示该班所有学生。
- **查找学生**：在表格的第一列（学号/Student ID）中查找与 Excel `studentId` 相同的行，抓取该行的姓名、中文名、学号等数据并返回/记录。

下面是一个可直接用的 Selenium（Python）示例函数，示范如何选择班级并依据 `studentId` 找到学生资料：

```python
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC

def select_class_and_find_student(driver, class_short: str, student_id: str, timeout=8):
    """选择班级（根据简写如 'S3B'）并在下方表格中找到 student_id 的行，返回该行的字段。

    Args:
        driver: 已登入并在活动页面的 Selenium WebDriver
        class_short: Excel 中的班级简写，例如 'S3B'
        student_id: 要查找的学号，例如 '20019'
    Returns:
        dict 或 None: {'student_no':..., 'name_en':..., 'name_cn':..., 'class_name':...} 或 None 若找不到
    """

    # 找到 class select
    sel = WebDriverWait(driver, timeout).until(
        EC.presence_of_element_located((By.ID, 'class_id'))
    )

    select = Select(sel)

    # 匹配 option 文本中包含 '(S3B)' 或尾部是 'S3B'
    matched_value = None
    for opt in sel.find_elements(By.TAG_NAME, 'option'):
        text = opt.text.strip()
        if f'({class_short})' in text or text.endswith(class_short):
            matched_value = opt.get_attribute('value')
            break

    if not matched_value:
        print(f"未找到匹配的班级选项: {class_short}")
        return None

    # 选择该 option（通过 value）
    select.select_by_value(matched_value)

    # 等待表格更新：tbody 出现至少一列或特定学号的行
    try:
        WebDriverWait(driver, timeout).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, 'table.table tbody tr'))
        )
    except Exception:
        print('表格未在时间内加载完毕')
        return None

    # 遍历表格行查找 student_id
    rows = driver.find_elements(By.CSS_SELECTOR, 'table.table tbody tr')
    for r in rows:
        cols = r.find_elements(By.TAG_NAME, 'td')
        if not cols:
            continue
        stu_no = cols[0].text.strip()
        if stu_no == str(student_id):
            # 依照附件示例：cols -> [学号, 英文名, 中文名, 班级, 操作]
            return {
                'student_no': stu_no,
                'name_en': cols[1].text.strip(),
                'name_cn': cols[2].text.strip(),
                'class_name': cols[3].text.strip(),
            }

    print(f'在表格中未找到学号 {student_id}')
    return None
```

示例使用场景（整合到主流程中）：

```python
# 1) 登入并导航到活动新增页面
# 2) 填写活动日期与活动项目（参照上方 get_activity_name 函数）
# 3) 点击学生名单按钮：
driver.find_element(By.ID, 'yw4').click()

# 4) 调用上面的函数：
result = select_class_and_find_student(driver, class_short='S3B', student_id='20019')
if result:
    print('找到學生：', result)
else:
    print('找不到學生，請確認班級或学号是否正确')
```

说明与注意事项：
- `class_id` 下拉的选项为全称（含中文）+ 英文简写在括号内，脚本匹配时以括号内简写为主。
- 若 Excel 中学生列表的起始列/格式与这里不完全相同，请先将 Excel 的 `class`/`studentId` 列转换或指定参数传入。
- 点击 `学生名单按钮` 前请确保已填写 `日期` 和 `活动项目`，否则页面可能不会弹出学生列表。


## 备注
- 建议使用 Selenium（Python）自动化上传时，先使用 `send_keys` 或选择器点击来填入表单，再上传学生名单资料。
- 若 Excel 中有多位学生，请在上传脚本中逐行读取并对照表单字段进行提交。
- 如需我帮你把这些 XPath 转成 Selenium 示例代码（含读取 `Upload.xlsx` 的范例），我可以接着实现。

---

## 编码实现（Python Selenium）

### 核心依赖
```
selenium >= 4.0
webdriver-manager >= 3.8.0
openpyxl >= 3.0
```

### 登入 SMS 系统

```python
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
import time

# 配置
SMS_URL = "http://sms.chhsban.edu.my/sms/index.php?r=site/login"
USERNAME = "schhs334"  # 注意：不要在代码中明文放置真实凭证
PASSWORD = "schhs334"

def login_to_sms(driver):
    """登入 SMS 系统"""
    print("[1] 连接到登入页面...")
    driver.get(SMS_URL)
    time.sleep(2)
    
    print("[2] 填入凭证...")
    driver.find_element(By.ID, "LoginForm_username").send_keys(USERNAME)
    driver.find_element(By.ID, "LoginForm_password").send_keys(PASSWORD)
    
    print("[3] 提交表单...")
    driver.find_element(By.XPATH, "//button[@type='submit']").click()
    
    # 等待重定向离开登入页面
    print("[4] 等待登入完成...")
    WebDriverWait(driver, 10).until(
        lambda d: "login" not in d.current_url.lower()
    )
    time.sleep(2)
    print("✓ 登入成功！")
```

### 通过 Select2 选择活动项目

**关键注意事项：**
1. **Select2 是一个 jQuery 插件**，需要通过 JavaScript 的 Select2 API 来操作
2. **活动代码格式**：例如 `ACA CMO183`，完整名称为 `ACA CMO183 - Malaysian Physics Olympiad (OFM) 2025`
3. **搜索策略**：先尝试通过 Select2 搜索输入框搜索，如果失败则直接通过 hidden select 元素的 value 属性设置
4. **等待时间**：Select2 下拉菜单打开和搜索结果出现需要足够的等待时间（通常 1-2 秒）

```python
def get_activity_name(driver, activity_code: str):
    """
    导航到活动页面并获取活动名称
    
    Args:
        driver: Selenium WebDriver
        activity_code: 活动代码（从 Excel A2 读取，例如 "ACA CMO183"）
    
    Returns:
        str: 活动完整名称，若失败返回 "查無此活動"
    """
    ACTIVITY_PAGE = "http://sms.chhsban.edu.my/sms/index.php?r=transaction/studentPerformance/create"
    
    print(f"\n[5] 导航到活动页面...")
    driver.get(ACTIVITY_PAGE)
    time.sleep(3)
    
    print(f"[6] 查找活动代码: {activity_code}")
    
    try:
        # 方法 1: 通过 Select2 搜索输入框
        print("    方法 1: 通过 Select2 搜索...")
        
        search_script = f"""
        var select = $('#StudentPerformanceM_item_id');
        
        // 打开 Select2 下拉菜单
        select.select2('open');
        var searchInput = document.querySelector('.select2-input');
        if (searchInput) {{
            searchInput.value = '{activity_code}';
            // 触发搜索事件
            searchInput.dispatchEvent(new Event('input', {{ bubbles: true }}));
            searchInput.dispatchEvent(new Event('keyup', {{ bubbles: true }}));
            searchInput.dispatchEvent(new Event('change', {{ bubbles: true }}));
        }}
        
        return 'searching...';
        """
        
        driver.execute_script(search_script)
        time.sleep(2)
        
        # 获取搜索结果
        result_script = """
        var resultLabel = document.querySelector('.select2-result-label');
        if (resultLabel && resultLabel.innerText.trim()) {
            return resultLabel.innerText;
        }
        return null;
        """
        
        activity_name = driver.execute_script(result_script)
        
        if activity_name and activity_name.strip():
            print(f"    发现活动: {activity_name}")
            
            # 点击选中
            click_script = """
            var resultLabel = document.querySelector('.select2-result-label');
            if (resultLabel) {
                resultLabel.click();
                return true;
            }
            return false;
            """
            
            clicked = driver.execute_script(click_script)
            if clicked:
                time.sleep(1)
                print(f"✓ 成功选择活动: {activity_name}")
                return activity_name
        
        print("    方法 1 失败，尝试方法 2...")
        
        # 方法 2: 直接通过 hidden select 的 value 属性设置
        print("    方法 2: 直接设置 hidden select value...")
        
        set_value_script = f"""
        var select = $('#StudentPerformanceM_item_id');
        var options = select.find('option');
        var targetValue = null;
        var resultText = null;
        
        // 遍历所有 option，找出以活动代码开头的项目
        for (var i = 0; i < options.length; i++) {{
            var text = options[i].innerText || options[i].text;
            if (text.indexOf('{activity_code}') === 0) {{
                targetValue = options[i].value;
                resultText = text;
                break;
            }}
        }}
        
        if (targetValue) {{
            select.val(targetValue);
            select.select2('data', {{id: targetValue, text: resultText}});
            select.trigger('change');
            return resultText;
        }}
        
        return null;
        """
        
        activity_name = driver.execute_script(set_value_script)
        
        if activity_name:
            print(f"    发现活动: {activity_name}")
            print(f"✓ 成功选择活动: {activity_name}")
            return activity_name
        else:
            print("    方法 2 也失败了")
            return "查無此活動"
    
    except Exception as e:
        print(f"✗ 错误: {e}")
        return "查無此活動"
```

### 读写 Excel 文件

```python
from openpyxl import load_workbook

def read_and_write_excel(activity_name: str, excel_path: str):
    """读取 Excel A2 并写入 B3"""
    try:
        print(f"\n[7] 打开 Excel 文件...")
        workbook = load_workbook(excel_path)
        worksheet = workbook.active
        
        # 读取 A2
        activity_code = worksheet['A2'].value
        print(f"✓ 从 A2 读取活动代码: {activity_code}")
        
        # 写入 B3
        print(f"[8] 将 '{activity_name}' 写入 B3...")
        worksheet['B3'] = activity_name
        
        workbook.save(excel_path)
        print(f"✓ 成功写入 B3: {activity_name}")
        return True
    
    except Exception as e:
        print(f"✗ 无法操作 Excel: {e}")
        return False
```

### 完整使用流程

```python
if __name__ == "__main__":
    # 浏览器配置
    options = Options()
    options.add_argument('--disable-blink-features=AutomationControlled')
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
    
    try:
        # 登入
        login_to_sms(driver)
        
        # 读取 Excel A2
        workbook = load_workbook("Upload.xlsx")
        worksheet = workbook.active
        activity_code = worksheet['A2'].value
        
        # 选择活动
        activity_name = get_activity_name(driver, activity_code)
        
        # 写入 B3
        read_and_write_excel(activity_name, "Upload.xlsx")
        
        print("\n✓ 流程完成！")
    
    finally:
        driver.quit()
```

---

## 常见问题和解决方案

| 问题 | 原因 | 解决方案 |
|------|------|--------|
| 登入失败 | 凭证错误或账户被锁定 | 检查 USERNAME / PASSWORD，或在网页上手动登入测试 |
| Select2 搜索无结果 | 活动代码不存在或格式错误 | 检查 `element.txt` 中的 `<option>` 列表，确保代码存在 |
| 找不到 Excel 文件 | 路径不正确 | 确保 `Upload.xlsx` 在脚本同一目录中 |
| 浏览器自动关闭 | JavaScript 执行错误 | 添加 try-except 并检查浏览器控制台错误 |

---

## 安全建议

- **凭证存储**：不要在代码中硬编码用户名和密码，改用环境变量：
  ```python
  USERNAME = os.getenv("SMS_USERNAME", "default_user")
  PASSWORD = os.getenv("SMS_PASSWORD", "default_pass")
  ```
  
- **会话管理**：考虑使用 Cookie 保存会话，避免每次都重新登入

---

## 测试验证

✓ 已成功测试的活动代码：
- `ACA CMO183 - Malaysian Physics Olympiad (OFM) 2025`

完整的测试脚本见 `test_get_activity.py`


